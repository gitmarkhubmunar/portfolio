server {
    listen          80;
    listen          [::]:80;
    server_name     thevisual.work www.thevisual.work;
    
    root            /var/www/thevisual.work;

    # Needed for react-router-dom
    location / {
        root        /var/www/thevisual.work;
        index       index.html index.htm;
        try_files   $uri $uri/ /index.html =404;
    }

    if ($host = www.thevisual.work) {
        return 301 https://thevisual.work$request_uri;
    }
    
    if ($host = thevisual.work) {
        return 301 https://$host$request_uri;
    }
}
server {
    listen          443 ssl;
    listen          [::]:443 ssl ipv6only=on;
    server_name     thevisual.work www.thevisual.work;

    if ($host != thevisual.work) {
        return 301  https://thevisual.work$request_uri;
    }

    add_header      Access-Control-Allow-Origin "https://thevisual.work";
    add_header      Content-Security-Policy "default-src 'self'; script-src 'self' https://www.google-analytics.com https://cdn.mxpnl.com 'unsafe-inline' 'unsafe-eval'; style-src 'self' https://fonts.googleapis.com; img-src 'self' data:; font-src 'self' https://fonts.gstatic.com; connect-src 'self' https://*.haiku.ai";
    add_header      Referrer-Policy "no-referrer, strict-origin-when-cross-origin";
    add_header      Strict-Transport-Security "max-age=63072000; includeSubDomains";
    add_header      Feature-Policy "accelerometer 'none'; camera 'none'; microphone 'none'";
    add_header      Expect-CT "enforce, max-age 30";

    ssl_certificate     /etc/certs/live/thevisual.work/fullchain.pem;
    ssl_certificate_key /etc/certs/live/thevisual.work/privkey.pem;

    ssl_session_timeout 1d;
    ssl_session_cache   shared:MozSSL:10m;  # about 40000 sessions
    ssl_session_tickets off;

    # modern configuration
    ssl_protocols   TLSv1.3;
    ssl_prefer_server_ciphers off;

    # OCSP stapling
    ssl_stapling        on;
    ssl_stapling_verify on;

    # verify chain of trust of OCSP response using Root CA and Intermediate certs
    ssl_trusted_certificate /etc/certs/live/thevisual.work/chain.pem;

    # replace with the IP address of your resolver
    resolver            173.255.241.5 74.207.242.5 173.255.243.5;
    
    # Needed for react-router-dom
    location / {
        root        /var/www/thevisual.work;
        
        error_page  404 /404.xhtml;
    
        if ($request_method = 'OPTIONS') {
            add_header  'Access-Control-Allow-Origin' 'https://thevisual.work';

            add_header  'Access-Control-Allow-Credentials' 'true';
            add_header  'Access-Control-Allow-Methods' 'GET, POST, OPTIONS';

            add_header  'Access-Control-Allow-Headers' 'DNT,Keep-Alive,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type';

            add_header  'Access-Control-Max-Age' 1728000;
            add_header  'Content-Type' 'text/plain charset=UTF-8';
            add_header  'Content-Length' 0;
            return      204;
        }

        index       index.html index.htm;
        try_files   $uri $uri/ /index.html =404;
    }
}
